{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
    Cooknomics - Recipes
{% endblock title %}

{%  block app_title %}
<span class="app_title">RECIPES</span>
{% endblock app_title %}

{% block content %}
    <div id="search-container">
        <span id="error-message" style="display: none; color: red;"></span>
        </br>
        <select id="ingredient-selecter" class="selectpicker"
                multiple data-live-search="true"
                data-selected-text-format="count > 3"
                title="Wybierz składnik"
        >
        </select>
        <button id="search-button" class="btn btn-default"
                style="padding-top: 6px; padding-bottom: 6px"
                type="button"
        >
        Wyszukaj
        </button>
    </div>

    <main>
        <ul class="element-list">
            {% for recipe in page %}
                <li>
                    <a href="{% url 'recipes:recipe' recipe.slug %}">
                        <h2 class="title">{{ recipe.title }}</h2>
                    </a>
                    <img src='{{ recipe.image.url }}' style="max-height:315px;width:auto;">
                </li>
            {% endfor %}
        </ul>
    </main>
{% endblock content %}

{% block scripts %}
    <!-- Script that gets new pages -->
    <script type="application/javascript">
        var pageNumber = {{ page.number }};
        var hasNextPage = {{ page.has_next|lower }};
        var url = '{% url 'recipes:page' %}';
    </script>
    <script type="application/javascript" src="{% static 'js/scripts.js' %}"></script>
    <script type="application/javascript" src="{% static 'recipes/js/scripts.js' %}" ></script>

    <script type="application/javascript">
        $(document).ready(function() {

            /* Fill product select list */
            var $productList = $('#ingredient-selecter');

            $.ajax({
                type:  'GET',
                url: '{% url 'recipes:get_items' %}'
            })
            .done(function(data) {
                $.each(data, function(index, parameter) {
                    $.each(parameter, function(name, value) {
                        $productList.append('<option value="' + value + '">' + name + '</option>');
                    });
                })
            })
            .error(function(jqXHR) {
                console.log("AJAX error: " + jqXHR.status);
            });


            /* Add search button onlick listener */
            $("#search-button").click(function() {
                var selectedItems = $productList.val();
                var $errorMessage = $('#error-message');
                var $initalList = $(".element-list");

                if (selectedItems != null) {
                    $initalList.empty();
                } else { /* TODO: ZAMIAST TEGO WYCIAGNIJ LISTE WSZYSTKICH */
                    $errorMessage.text("Nie wybrano żadnego składnika.");
                    $errorMessage.show();
                    return;
                }

                $.ajax({
                    type: 'GET',
                    url: '{% url 'recipes:process_items' %}',
{#                    data: JSON.stringify(selectedItems),#}
                    data: {},
                    dataType: 'json',
                    encode: true
                })
                .done(function(data) {
                    $errorMessage.hide();
                    console.log("Successful request.");

                    var newPage = data.page.objects;
                    appendElements(newPage);
                })
                .error(function(jqXHR) {
                    $errorMessage.text("Bład serwera: " + jqXHR.status);
                    $errorMessage.show();
                    console.log("AJAX error: " + jqXHR.status)
                })
            })
        });
    </script>
{% endblock scripts %}
